name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  analyze:
    name: Analyze and Check
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies for tool
        run: |
          cd tool
          dart pub get

      - name: Install dependencies for marionette_mcp
        run: |
          cd packages/marionette_mcp
          dart pub get

      - name: Install dependencies for marionette_flutter
        run: |
          cd packages/marionette_flutter
          flutter pub get

      - name: Check version.g.dart is in sync
        run: |
          dart tool/generate_version.dart
          if ! git diff --exit-code packages/marionette_mcp/lib/src/version.g.dart; then
            echo "ERROR: version.g.dart is out of sync. Please run 'dart tool/generate_version.dart' and commit the changes."
            exit 1
          fi

      - name: Analyze marionette_mcp
        run: |
          cd packages/marionette_mcp
          dart analyze --fatal-infos lib bin

      - name: Analyze marionette_flutter
        run: |
          cd packages/marionette_flutter
          flutter analyze --fatal-infos lib

      - name: Check formatting for marionette_mcp
        run: |
          cd packages/marionette_mcp
          dart format --set-exit-if-changed lib bin

      - name: Check formatting for marionette_flutter
        run: |
          cd packages/marionette_flutter
          dart format --set-exit-if-changed lib

      - name: Check formatting for tool
        run: |
          cd tool
          dart format --set-exit-if-changed .
